<script>
  (async () => {
    const hash = new URLSearchParams(location.search).get("hash");
    const statusDiv = document.getElementById("status");
    if (!hash) return statusDiv.textContent = "No hash.";

    const provider = new ethers.providers.JsonRpcProvider("https://alfajores-forno.celo-testnet.org");
    const contractAddress = "0x8715831b69dcc1c0a569b3aae3d268156e789fb6";
    const abi = ["event ReceiptLogged(address indexed sender, string receiptHash, uint256 timestamp)"];
    const contract = new ethers.Contract(contractAddress, abi, provider);

    try {
      const logs = await contract.queryFilter(contract.filters.ReceiptLogged(), 0, "latest");
      const match = logs.find(log => log.args.receiptHash === hash);

      if (match) {
        const date = new Date(match.args.timestamp.toNumber() * 1000);
        statusDiv.innerHTML = `
          <p>✅ <strong>Receipt verified!</strong></p>
          <p><strong>Seller:</strong> ${match.args.sender}</p>
          <p><strong>Timestamp:</strong> ${date.toISOString()}</p>
          <p><strong>Hash:</strong> ${hash}</p>`;
      } else {
        statusDiv.textContent = "❌ Receipt not found on chain.";
      }
    } catch (err) {
      console.error(err);
      statusDiv.textContent = "Error verifying receipt.";
    }
  })();
</script>
